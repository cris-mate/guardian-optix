
<!doctype html>
<html lang="en">

<head>
    <title>Code coverage report for controllers/guardsController.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <link rel="shortcut icon" type="image/x-icon" href="../favicon.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
    
<body>
<div class='wrapper'>
    <div class='pad1'>
        <h1><a href="../index.html">All files</a> / <a href="index.html">controllers</a> guardsController.js</h1>
        <div class='clearfix'>
            
            <div class='fl pad1y space-right2'>
                <span class="strong">72.94% </span>
                <span class="quiet">Statements</span>
                <span class='fraction'>62/85</span>
            </div>
        
            
            <div class='fl pad1y space-right2'>
                <span class="strong">58.06% </span>
                <span class="quiet">Branches</span>
                <span class='fraction'>36/62</span>
            </div>
        
            
            <div class='fl pad1y space-right2'>
                <span class="strong">75% </span>
                <span class="quiet">Functions</span>
                <span class='fraction'>6/8</span>
            </div>
        
            
            <div class='fl pad1y space-right2'>
                <span class="strong">74.69% </span>
                <span class="quiet">Lines</span>
                <span class='fraction'>62/83</span>
            </div>
        
            
        </div>
        <p class="quiet">
            Press <em>n</em> or <em>j</em> to go to the next uncovered block, <em>b</em>, <em>p</em> or <em>k</em> for the previous block.
        </p>
        <template id="filterTemplate">
            <div class="quiet">
                Filter:
                <input type="search" id="fileSearch">
            </div>
        </template>
</div>
    <div class='status-line medium'></div>
    < class="coverage">

<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10x</span>
<span class="cline-any cline-yes">10x</span>
<span class="cline-any cline-yes">10x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6x</span>
<span class="cline-any cline-yes">6x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">/**
 * Guards Controller
 *
 * Handles API requests for guards management.
 * Uses the unified User model with role-based filtering.
 */
&nbsp;
const User = require('../models/User');
const asyncHandler = require('../utils/asyncHandler');
&nbsp;
/**
 * @route   GET /api/guards
 * @desc    Get all guards (Guards and Managers)
 * @access  Private
 */
const getGuards = asyncHandler(async (req, res) =&gt; {
  const {
    search,
    status,
    role,
    guardType,
    shift,
    availability,
    licenceStatus,
    sortBy = 'fullName',
    sortOrder = 'asc',
    page = 1,
    limit = 20,
  } = req.query;
&nbsp;
  // Build query
  const query = {
    // Exclude Admin users from guards list (they are system admins, not field staff)
    role: { $in: ['Guard', 'Manager'] },
  };
&nbsp;
  // Search filter
  if (search) {
    query.$or = [
      { fullName: { $regex: search, $options: 'i' } },
      { email: { $regex: search, $options: 'i' } },
      { siaLicenceNumber: { $regex: search, $options: 'i' } },
      { postCode: { $regex: search, $options: 'i' } },
    ];
  }
&nbsp;
  // Status filter
  <span class="missing-if-branch" title="if path not taken" >I</span>if (status &amp;&amp; <span class="branch-1 cbranch-no" title="branch not covered" >status !== 'all')</span> {
<span class="cstat-no" title="statement not covered" >    query.status = status;</span>
  }
&nbsp;
  // Role filter
  <span class="missing-if-branch" title="if path not taken" >I</span>if (role &amp;&amp; <span class="branch-1 cbranch-no" title="branch not covered" >role !== 'all')</span> {
<span class="cstat-no" title="statement not covered" >    query.role = role;</span>
  }
&nbsp;
  // Guard type filter
  if (guardType &amp;&amp; guardType !== 'all') {
    query.guardType = guardType;
  }
&nbsp;
  // Shift filter
  <span class="missing-if-branch" title="if path not taken" >I</span>if (shift &amp;&amp; <span class="branch-1 cbranch-no" title="branch not covered" >shift !== 'all')</span> {
<span class="cstat-no" title="statement not covered" >    query.shift = shift;</span>
  }
&nbsp;
  // Availability filter
  if (availability &amp;&amp; availability !== 'all') {
    query.availability = availability === 'available';
  }
&nbsp;
  // Licence status filter
  <span class="missing-if-branch" title="if path not taken" >I</span>if (licenceStatus &amp;&amp; <span class="branch-1 cbranch-no" title="branch not covered" >licenceStatus !== 'all')</span> {
<span class="cstat-no" title="statement not covered" >    query['siaLicence.status'] = licenceStatus;</span>
  }
&nbsp;
  // Build sort object
  const sortField = sortBy === 'name' ? <span class="branch-0 cbranch-no" title="branch not covered" >'fullName' </span>: sortBy;
  const sortObj = {};
  sortObj[sortField] = sortOrder === 'desc' ? <span class="branch-0 cbranch-no" title="branch not covered" >-1 </span>: 1;
&nbsp;
  // Execute query with pagination
  const skip = (parseInt(page) - 1) * parseInt(limit);
&nbsp;
  const [guards, total] = await Promise.all([
    User.find(query)
      .select('-password')
      .sort(sortObj)
      .skip(skip)
      .limit(parseInt(limit)),
    User.countDocuments(query),
  ]);
&nbsp;
  res.status(200).json({
    success: true,
    data: guards,
    pagination: {
      page: parseInt(page),
      limit: parseInt(limit),
      total,
      totalPages: Math.ceil(total / parseInt(limit)),
    },
  });
});
&nbsp;
/**
 * @route   GET /api/guards/stats
 * @desc    Get guards statistics
 * @access  Private
 */
const getGuardsStats = asyncHandler(async (req, res) =&gt; {
  const stats = await User.aggregate([
    { $match: { role: { $in: ['Guard', 'Manager'] } } },
    {
      $group: {
        _id: null,
        total: { $sum: 1 },
        onDuty: { $sum: { $cond: [{ $eq: ['$status', 'on-duty'] }, 1, 0] } },
        offDuty: { $sum: { $cond: [{ $eq: ['$status', 'off-duty'] }, 1, 0] } },
        onBreak: { $sum: { $cond: [{ $eq: ['$status', 'on-break'] }, 1, 0] } },
        late: { $sum: { $cond: [{ $eq: ['$status', 'late'] }, 1, 0] } },
        absent: { $sum: { $cond: [{ $eq: ['$status', 'absent'] }, 1, 0] } },
        scheduled: { $sum: { $cond: [{ $eq: ['$status', 'scheduled'] }, 1, 0] } },
        expiringLicences: {
          $sum: {
            $cond: [
              { $in: ['$siaLicence.status', ['expiring-soon', 'expired']] },
              1,
              0,
            ],
          },
        },
      },
    },
  ]);
&nbsp;
  res.status(200).json({
    success: true,
    data: stats[0] || <span class="branch-1 cbranch-no" title="branch not covered" >{</span>
      total: 0,
      active: 0,
      onLeave: 0,
      offDuty: 0,
      expiringLicences: 0,
    },
  });
});
&nbsp;
/**
 * @route   GET /api/guards/:id
 * @desc    Get single guard by ID
 * @access  Private
 */
const getGuardById = asyncHandler(async (req, res) =&gt; {
  const guard = await User.findById(req.params.id).select('-password');
&nbsp;
  if (!guard) {
    res.status(404);
    throw new Error('Guard not found');
  }
&nbsp;
  res.status(200).json({
    success: true,
    data: guard,
  });
});
&nbsp;
/**
 * @route   POST /api/guards
 * @desc    Create new guard
 * @access  Private (Admin/Manager)
 */
const createGuard = asyncHandler(async (req, res) =&gt; {
  const {
    fullName,
    email,
    phoneNumber,
    postCode,
    role,
    guardType,
    siaLicenceNumber,
    siaLicenceType,
    siaLicenceExpiry,
  } = req.body;
&nbsp;
  // Check if email already exists
  const existingUser = await User.findOne({ email });
  if (existingUser) {
    res.status(400);
    throw new Error('Email already registered');
  }
&nbsp;
  // Build user object
  const userData = {
    fullName,
    email,
    username: email.split('@')[0], // Generate username from email
    phoneNumber,
    postCode,
    role,
    guardType: role === 'Guard' ? guardType : <span class="branch-1 cbranch-no" title="branch not covered" >undefined,</span>
    siaLicenceNumber,
    status: 'off-duty',
    availability: true,
    // Generate temporary password (should be changed on first login)
    password: Math.random().toString(36).slice(-8),
  };
&nbsp;
  // Add SIA licence if provided
  <span class="missing-if-branch" title="if path not taken" >I</span>if (siaLicenceNumber) {
<span class="cstat-no" title="statement not covered" >    userData.siaLicence = {</span>
      licenceNumber: siaLicenceNumber,
      licenceType: siaLicenceType || 'Security Guard',
      issueDate: new Date(),
      expiryDate: siaLicenceExpiry ? new Date(siaLicenceExpiry) : null,
      status: 'valid',
    };
  }
&nbsp;
  const guard = await User.create(userData);
&nbsp;
  // Remove password from response
  const response = guard.toObject();
  delete response.password;
&nbsp;
  res.status(201).json({
    success: true,
    data: response,
  });
});
&nbsp;
/**
 * @route   PUT /api/guards/:id
 * @desc    Update guard
 * @access  Private (Admin/Manager)
 */
const updateGuard = asyncHandler(async (req, res) =&gt; {
  const guard = await User.findById(req.params.id);
&nbsp;
  if (!guard) {
    res.status(404);
    throw new Error('Guard not found');
  }
&nbsp;
  // Prevent password update through this endpoint
  delete req.body.password;
&nbsp;
  const updatedGuard = await User.findByIdAndUpdate(
    req.params.id,
    req.body,
    { new: true, runValidators: true }
  ).select('-password');
&nbsp;
  res.status(200).json({
    success: true,
    data: updatedGuard,
  });
});
&nbsp;
/**
 * @route   DELETE /api/guards/:id
 * @desc    Delete guard (soft delete by setting status to 'suspended')
 * @access  Private (Admin only)
 */
const deleteGuard = asyncHandler(async (req, res) =&gt; {
  const guard = await User.findById(req.params.id);
&nbsp;
  if (!guard) {
    res.status(404);
    throw new Error('Guard not found');
  }
&nbsp;
  // Soft delete - set status to suspended
  guard.status = 'suspended';
  guard.availability = false;
  await guard.save();
&nbsp;
  res.status(200).json({
    success: true,
    message: 'Guard suspended successfully',
  });
});
&nbsp;
/**
 * @route   PATCH /api/guards/:id/status
 * @desc    Update guard status
 * @access  Private (Admin/Manager)
 */
const updateGuardStatus = asyncHandler(<span class="fstat-no" title="function not covered" >as</span>ync (req, res) =&gt; {
  const { status } = <span class="cstat-no" title="statement not covered" >req.body;</span>
  const validStatuses = <span class="cstat-no" title="statement not covered" >['active', 'on-leave', 'off-duty', 'suspended'];</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  if (!validStatuses.includes(status)) {</span>
<span class="cstat-no" title="statement not covered" >    res.status(400);</span>
<span class="cstat-no" title="statement not covered" >    throw new Error('Invalid status');</span>
  }
&nbsp;
  const guard = <span class="cstat-no" title="statement not covered" >await User.findByIdAndUpdate(</span>
    req.params.id,
    {
      status,
      availability: status === 'active',
    },
    { new: true }
  ).select('-password');
&nbsp;
<span class="cstat-no" title="statement not covered" >  if (!guard) {</span>
<span class="cstat-no" title="statement not covered" >    res.status(404);</span>
<span class="cstat-no" title="statement not covered" >    throw new Error('Guard not found');</span>
  }
&nbsp;
<span class="cstat-no" title="statement not covered" >  res.status(200).json({</span>
    success: true,
    data: guard,
  });
});
&nbsp;
/**
 * @route   GET /api/guards/available
 * @desc    Get available guards for assignment
 * @access  Private
 */
const getAvailableGuards = asyncHandler(<span class="fstat-no" title="function not covered" >as</span>ync (req, res) =&gt; {
  const { shift, guardType, postCode } = <span class="cstat-no" title="statement not covered" >req.query;</span>
&nbsp;
  const query = <span class="cstat-no" title="statement not covered" >{</span>
    role: 'Guard',
    status: 'active',
    postCode: postCode,
    availability: true,
  };
&nbsp;
<span class="cstat-no" title="statement not covered" >  if (shift) <span class="cstat-no" title="statement not covered" >query.shift = shift;</span></span>
<span class="cstat-no" title="statement not covered" >  if (guardType) <span class="cstat-no" title="statement not covered" >query.guardType = guardType;</span></span>
&nbsp;
  const guards = <span class="cstat-no" title="statement not covered" >await User.find(query)</span>
    .select('fullName siaLicenceNumber guardType shift postCode phoneNumber')
    .sort('fullName');
&nbsp;
<span class="cstat-no" title="statement not covered" >  res.status(200).json({</span>
    success: true,
    data: s,
  });
});
&nbsp;
module.exports = {
  getGuards: getGuards,
  getGuardsStats,
  getGuardById: getGuardById,
  createGuard: createGuard,
  updateGuard: updateGuard,
  deleteGuard: deleteGuard,
  updateGuardStatus: updateGuardStatus,
  getAvailableGuards: getAvailableGuards,
};</pre></td></tr><pre/>

                <div class='push'></div><!-- for sticky footer -->
            </div><!-- /wrapper -->
            <div class='footer quiet pad2 space-top1 center small'>
                Code coverage generated by
                <a href="https://istanbul.js.org/" target="_blank" rel="noopener noreferrer">istanbul</a>
                at 2025-12-12T08:20:01.238Z
            </div>
        <script src="../prettify.js"></script>
        <script>
            window.onload = function () {
                prettyPrint();
            };
        </script>
        <script src="../sorter.js"></script>
        <script src="../block-navigation.js"></script>
    </body>
</html>
    